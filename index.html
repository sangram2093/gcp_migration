<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>dbAura Report Portal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=last_updated) }}">
</head>
<body>
  <div class="container">
    <header>
      <h1>dbAura Report Portal</h1>
      <div class="header-actions">
        <a href="/download" class="btn download-btn">Download Excel Report</a>
      </div>
    </header>

    <div class="dashboard-grid">
      <!-- CARD 1: Search Entitlements (same height as others) -->
      <div class="card card--tall" id="search-card">
        <h2>Search Entitlements</h2>

        <form action="/search" method="post" class="search-form">
          <div class="form-group">
            <label for="search_type">Search by:</label>
            <select id="search_type" name="search_type">
              <option value="user" {% if search_type == 'user' %}selected{% endif %}>User Email</option>
              <option value="role" {% if search_type == 'role' %}selected{% endif %}>Roles</option>
              <option value="resource" {% if search_type == 'resource' %}selected{% endif %}>Resource</option>
            </select>
          </div>

          <div class="form-group">
            <label for="query">Search Term:</label>
            <input type="text" id="query" name="query" value="{{ query or '' }}" placeholder="Enter search term...">
          </div>

          <button type="submit" class="btn">Search</button>
        </form>

        {% if error %}
          <div class="error-display">
            <p>{{ error }}</p>
          </div>
        {% endif %}

        {% if results %}
        <div class="results">
          <h3>Search Results for ‘{{ query }}’</h3>
          <div class="scrollable-content">
            {% if search_type == 'user' %}
              <h4>Roles:</h4>
              {% if results.roles %}
                <ul>
                  {% for role in results.roles %}
                    <li>{{ role }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p>No roles found for this user.</p>
              {% endif %}

              <h4>Resources:</h4>
              {% if results.resources %}
                <ul>
                  {% for resource in results.resources %}
                    <li>{{ resource }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p>No resources found for this user.</p>
              {% endif %}

            {% elif search_type == 'role' or search_type == 'resource' %}
              <h4>Users:</h4>
              {% if results.users %}
                <ul>
                  {% for user in results.users %}
                    <li>{{ user }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p>No users found for this {{ search_type }}.</p>
              {% endif %}
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
      <!-- END CARD 1 -->

      <!-- CARD 2: Role Discrepancies (taller + smaller font + inline roles) -->
      <div class="card card--tall discrepancy-section" id="discrepancies-card">
        <h2>Role Discrepancies</h2>
        <div class="table-container">
          {% if discrepancy_data %}
            <table class="summary-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Missing Roles in UWQ</th>
                </tr>
              </thead>
              <tbody>
                {% for user, roles in discrepancy_data.items() %}
                <tr>
                  <td>{{ user }}</td>
                  <td>
                    <ul>
                      {% for role in roles %}
                        <li>{{ role }}</li>
                      {% endfor %}
                    </ul>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No discrepancies found.</p>
          {% endif %}
        </div>
      </div>
      <!-- END CARD 2 -->

      <!-- CARD 3: Function Summary (taller + tighter row spacing) -->
      <div class="card card--tall" id="function-summary-card">
        <h2>Function Summary</h2>
        <div class="table-container">
          {% if resource_summary %}
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Resource Group</th>
                  <th>Distinct User Count</th>
                </tr>
              </thead>
              <tbody>
                {% for group, count in resource_summary.items() %}
                  {% if group != 'total' %}
                  <tr>
                    <td>{{ group }}</td>
                    <td>{{ count }}</td>
                  </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Totals</strong></td>
                  <td><strong>{{ resource_summary_total }}</strong></td>
                </tr>
              </tfoot>
            </table>
          {% else %}
            <p>No resource data to summarize.</p>
          {% endif %}
        </div>

        {% if resource_summary %}
          <p class="total-users">Total Distinct Users: {{ total_distinct_users }}</p>
        {% endif %}
      </div>
      <!-- END CARD 3 -->

      <!-- CARD 4: Role Distribution (taller) -->
      <div class="card card--tall" id="role-distribution-card">
        <h2>Role Distribution</h2>
        <div class="chart-controls">
          <button class="btn chart-btn" onClick="renderChart('bar')">Bar Chart</button>
          <button class="btn chart-btn" onClick="renderChart('pie')">Pie Chart</button>
        </div>
        <div class="chart-container">
          <canvas id="roleChart"></canvas>
        </div>
      </div>
      <!-- END CARD 4 -->
    </div>

    <footer>
      <p>© dbAura Reporting Tool</p>
      {% if last_updated %}
        <p class="last-updated">Data last updated: {{ last_updated }}</p>
      {% endif %}
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Safely pass data from Flask to JavaScript
    window.chartData = JSON.parse('{{ chart_data | tojson | safe }}');
    let currentChart;

    function renderChart(type) {
      const ctx = document.getElementById('roleChart').getContext('2d');

      if (currentChart) currentChart.destroy();

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: type === 'pie' } }
      };

      if (type === 'bar') chartOptions.scales = { y: { beginAtZero: true } };

      currentChart = new Chart(ctx, {
        type,
        data: {
          labels: window.chartData.labels,
          datasets: [{
            label: '# of Users',
            data: window.chartData.data,
            backgroundColor: [
              'rgba(0, 86, 145, 0.7)','rgba(54, 162, 235, 0.7)','rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)','rgba(153, 102, 255, 0.7)','rgba(255, 159, 64, 0.7)',
              'rgba(240, 100, 132, 0.7)','rgba(0, 150, 136, 0.7)'
            ],
            borderColor: [
              'rgba(0, 86, 145, 1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)',
              'rgba(240, 100, 132, 1)','rgba(0, 150, 136, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: chartOptions
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (window.chartData && window.chartData.labels.length > 0) renderChart('bar');
    });
  </script>
</body>
</html>
